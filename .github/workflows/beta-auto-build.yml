name: Beta Auto Build
permissions:
    contents: write
on:
  push:
    branches: [ "beta" ]
  workflow_dispatch:
jobs:
  build-beta:
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        run: |
          VERSION=$(cat "resources/universal-mod/version/mod-version.txt" | tr -d ' \n')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Extract commit Hash
        run: |
          COMMIT_HASH=$(grep -oE '[0-9a-f]{7,}' "resources/universal-mod/res-texts/texts-eng_res/string version_name" | head -n 1)
          echo "COMMITHASH=$COMMITHASH" >> $GITHUB_ENV

      - name: Declare ZIP_NAME and check the other variables
        run: |
          ZIP_NAME="Universal-Mod-$VERSION-beta-$COMMITHASH.zip"
          echo "ZIPNAME=$ZIPNAME" >> $GITHUB_ENV
          echo "$VERSION"
          echo "$COMMITHASH"
          echo "$ZIPNAME"
          
      - name: Create release archive
        uses: thedoctor0/zip-release@0.7.5
        with:
          type: 'zip'
          path: "Universal-Mod"
          filename: "$ZIPNAME"
          
      - name: Upload release
        uses: ncipollo/release-action@v1.12.0
        # Docs here : https://github.com/marketplace/actions/create-release
        with:
          artifacts: $ZIPNAME
          token: ${{ secrets.GITHUB_TOKEN }}
          makeLatest: true
          name: Latest Beta Build $VERSION $COMMITHASH
          tag: beta-latest
          prerelease: true
          generateReleaseNotes: true
          allowUpdates: true
          replacesArtifacts: true
          
